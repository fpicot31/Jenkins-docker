pipeline {

  environment {
     registry = "atos06/ipiformation"
     registryCredential = 'docker-hub-credentials'
     dockerImage = ''
  }

  agent any
  
  stages {

    stage('Build de l application') {
      steps {
        script {
           dockerImage = docker.build registry + ":$BUILD_NUMBER"
        }
      }
    }

    stage('Delcenchement des tests') {
      parallel {

        stage('Test affichage de la page d accueil') {
          steps {
            script {
               docker.image(registry+":$BUILD_NUMBER").withRun('--rm -p 80:80 --name devops') { c ->
                  sh 'docker ps'
                  sh 'docker exec devops curl localhost:80'
                  sh 'echo "Tests passed"'
               }
            }
          }
        }

        stage('Test integration') {
          steps {
            script {
              sh 'sleep 5'
            }
          }
        }

        stage('Test fonctionnel') {
          steps {
            script {
              sh 'sleep 5'
            }
          }
        }

        stage('Analyse qualité du code') {
          steps {
            script {
              sh 'sleep 5'
            }
          }
        }

        stage('Test de securité') {
          steps {
            script {
              sh 'sleep 5'
            }
          }
        }


      }
    }

    stage('Livraison') {
       steps{
          script {
             docker.withRegistry('https://registry.hub.docker.com', registryCredential ) {
                dockerImage.push("1.0")
             }
          }
       }
    }


    stage('Deploiement') {
      parallel {

        stage('Environnement de developpement') {
          steps {
            script {
              sh 'sleep 5'
            }
          }
        }

        stage('Environnement integration') {
          steps {
            script {
              sh 'sleep 5'
            }
          }
        }


sh '''
          [ -d ~/.ssh ] || mkdir ~/.ssh && chmod 0700 ~/.ssh
          ssh-keyscan -t rsa,dsa example.com >> ~/.ssh/known_hosts
          ssh user@example.com ...
      '''
      
      
        stage('Environnement de production') {
          steps {
            script {
              def dockerRun = 'sudo docker run -d --name monserver -p 8081:80 atos06/ipiformation:1.0'
           
              sshagent(['srvprod']) {
                 sh 'ssh -v -o StrictHostKeyChecking=no -l vagrant 192.168.5.5 ${dockerRun}'
              }
            }
          }
        }
      
      } 
    }

  }
}
